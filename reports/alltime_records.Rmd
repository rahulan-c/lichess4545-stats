---
output:
  html_document:
    css: theme.css
    theme: flatly
    dev: svglite
    toc: yes
    toc_depth: 4
    toc_float: true
    includes:
      in_header: head-custom-google-analytics.html
    self-contained: FALSE
title: "All-time records"
site: distill::distill_website
---



```{r packages_initial_opts, include = FALSE}
# Set default R chunk options for Rmd file
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

# Load all required packages, incl. for functions
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, knitr, rio, kableExtra, gghighlight, data.table,
               ggrepel, ggridges, reactable, htmltools, httr, jsonlite, xml2, 
               rvest, ndjson, reshape2, utf8, lubridate, tictoc, cowplot, 
               tippy)

# Define custom default reactable theme for tables
options(reactable.theme = reactableTheme(
    borderColor = "#dfe2e5",
    stripedColor = "#f6f8fa",
    highlightColor = "#f0f5f9",
    cellPadding = "8px 12px",
    searchInputStyle = list(width = "100%"),
    headerStyle = list(
      "&:hover[aria-sort]" = list(background = "hsl(0, 0%, 96%)"),
      "&[aria-sort='ascending'], &[aria-sort='descending']" = list(background = "hsl(0, 0%, 96%)"),
      borderColor = "#555"
    )
  )
)

```

```{r load_functions_lookups}
# # Source supporting functions
# source("C:/Users/rahul/Documents/Github/rahulan-c.github.io/lichess4545-stats/scripts/all_functions.R", local = knitr::knit_global())

# Load supporting lookup data

# 1. Gambit openings - to enable analysis of gambits and gambit-lovers
gambits <- read.csv("C:/Users/rahul/Documents/Github/rahulan-c.github.io/lichess4545-stats/data/lookup/gambits.csv")

# 2. FIDE performance rating lookup values
# 2-column table with tournament performance scores and rating differences
# Compiled from https://handbook.fide.com/chapter/B022017
# Required for calculating player performance ratings using FIDE's method 
fide_tpr_lookup <- read.csv("C:/Users/rahul/Documents/Github/rahulan-c.github.io/lichess4545-stats/data/lookup/fide_tpr_lookup.csv")

```


```{r}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, rio, data.table, reactable, httr, jsonlite, xml2, 
               rvest, ndjson, reshape2, utf8, lubridate, tictoc, reticulate,
               rmarkdown, fs, stringi, git2r)
```

```{r setup, eval = FALSE}
# Load data for all-time stats

# Games
data_path <- "C:/Users/rahul/Documents/Github/rahulan-c.github.io/lichess4545-stats/data/"

# Get data on season games, pairings and positions
league_load_label <- league
if(league == "lonewolf"){
  if(lw_u1800){league_load_label <- "lwu1800"} else {league_load_label <- "lwopen"}
}

# Load (tidied) games data
games <- readRDS(paste0(data_path, "games_", league_load_label, "_s", season, ".rds"))

# Load website pairings data
website_pairings <- readRDS(paste0(data_path, "website_pairings_", league_load_label, "_s", season, ".rds"))

# Load season pairings 
pairings <- rio::import(paste0(data_path, "pairings_", league_load_label, "_s", season, ".csv"))

# Load season team/player positions data
positions <- rio::import(paste0(data_path, "positions_", league_load_label, "_s", season, ".csv"))

# Load data on all 4545/LW games - required for determing the Rookie Award
all_games <- readr::read_rds(paste0(data_path, "combined_league_games_210804_tidied.rds"))


# ---- 3) TIDY SEASON DATA FOR REPORTS ----------------------------------------

# Add gambits data
games <- left_join(games, gambits, by = c("opening.name" = "gambit"))

# Fix character encoding in data
fix_character_encoding <- function(df){
  df <- df %>% 
    mutate(across(where(is.character), ~ str_replace_all(.x, "Ã¼", "ü"))) %>% 
    mutate(across(where(is.character), ~ str_replace_all(.x, "Ã¶", "ö"))) %>% 
    mutate(across(where(is.character), ~ str_replace_all(.x, "Ã³", "ó"))) %>% 
    mutate(across(where(is.character), ~ str_replace_all(.x, "Ã©", "é"))) %>% 
    mutate(across(where(is.character), ~ str_replace_all(.x, "â€¾", "‾"))) %>% 
    mutate(across(where(is.character), ~ str_replace_all(.x, "ãƒ„", "ツ"))) %>% 
    mutate(across(where(is.character), ~ str_replace_all(.x, "â€™", "'"))) %>% 
    mutate(across(where(is.character), ~ str_replace_all(.x, "’", "'")))
  return(df)
}

# Fix character encoding
games <- fix_character_encoding(games)
website_pairings <- fix_character_encoding(website_pairings)
pairings <- fix_character_encoding(pairings)
positions <- fix_character_encoding(positions)


# Remove all games and pairings featuring players banned from the leagues for cheating

# Exclude these players from the games data
games_excl_violators <- games %>%
  filter(!(players.white.user.name %in% tos_violators)) %>%
  filter(!(players.black.user.name %in% tos_violators)) %>%
  filter(!(players.white.user.id %in% str_to_lower(tos_violators))) %>%
  filter(!(players.black.user.id %in% str_to_lower(tos_violators)))

# Exclude from pairings data
pairings_excl_violators <- pairings %>%
  filter(!(white %in% tos_violators)) %>%
  filter(!(black %in% tos_violators)) %>%
  filter(!(white %in% str_to_lower(tos_violators))) %>%
  filter(!(black %in% str_to_lower(tos_violators)))

```

### Introduction

This page is under construction. Click [here](https://rahulan-c.github.io/lichess4545-stats/) to return to the home page.


### All award winners

This is just a collated list of all the various award winners in the 4545 and LoneWolf season reports that you can find [here](https://rahulan-c.github.io/lichess4545-stats/#season-stats).^[For now, you'll need to refer to a season report to find the definitions of some of the more obscurely named awards.) Note that this table currently doesn't show: (i) players who finished with a podium position in LoneWolf or who played on a podium-finishing team in the 4545 league; (ii) players who topped their board-specific performance rating table in the 4545 league (min. 4 games played); (iii) players who earned "honourable mentions" (because we can't all be winners). These three things probably belong here but will take some work to transfer. The table also doesn't include winners of team-based awards such as the Egalitarian and Team Accuracy Awards.]


```{r}
# Crawl over the other reports and present all winners in one table

# Extract all links from season reports table on homepage
homepage_url <- "https://rahulan-c.github.io/lichess4545-stats/"
season_reports <- read_html(homepage_url) %>% 
  html_nodes("table") %>% 
  html_nodes("tr") %>% 
  html_nodes("a") %>%
  html_attr("href")

# Now loop through all reports and extract award winners/details
all_awards <- list(rep(NA, length(season_reports)))
for(s in seq(1:length(season_reports))){
  url <- season_reports[s]
  league <- ifelse(str_detect(url, "stats_4545"), 
                   "4545", 
                   ifelse(str_detect(url, "stats_lwopen"), 
                          "LW Open", 
                          ifelse(str_detect(url, "stats_lwu1800"), 
                                 "LW U1800", 
                                 ifelse(str_detect(url, "stats_chess960"),
                                        "Chess960",
                                        ""))))
  
  season <- as.integer(str_extract(url, "(?<=_s)\\d+"))
  
  xml_child_number <- ifelse(league == "4545", 
                             ifelse(season %in% c(4, 5, 10, 12, 13, 25, 26, 27),
                                    4,
                                    5),
                             ifelse(league == "LW Open",
                                    ifelse(season %in% c(10, 13, 22, 23),
                                           4,
                                           5),
                                    ifelse(league == "LW U1800",
                                           ifelse(season %in% c(11, 13, 22, 23),
                                                  4,
                                                  5),
                                           ifelse(league == "Chess960",
                                                  ifelse(season %in% c(2:18),
                                                         4,
                                                         5)))))
  
  awards <- read_html(url) %>%
    rvest::html_element("#awards") %>% 
    xml_child(xml_child_number) %>% 
    html_text2() %>% 
    parse_json()
  
  awards_tidy <- as_tibble(awards$x$tag$attribs$data) %>%
    mutate(League = league, Season = season) %>% 
    select(-c(Image)) %>% 
    select(League, Season, Award, Winner, Details) %>% 
    # Flatten list to columns, turning NULL values to NAs
    mutate(Award = Award %>% lapply(function(x) ifelse(is.null(x), NA, x)) %>% purrr::flatten() %>% unlist(),
           Winner = Winner %>% lapply(function(x) ifelse(is.null(x), NA, x)) %>% purrr::flatten() %>% unlist(),
           Details = Details %>% lapply(function(x) ifelse(is.null(x), NA, x)) %>% purrr::flatten() %>% unlist())
  
  all_awards[[s]] <- awards_tidy
  cli::cli_inform("{league} S{season} done")
  Sys.sleep(0.2)
}

# Combine everything into a single data frame
awards <- data.table::rbindlist(all_awards)

# Tidy the data
awards <- awards %>% 
  filter(Winner != "") %>% # exclude non-awarded awards
  filter(!(Award %in% c("Egalitarian Award", "Team Accuracy", "Radjabov Award"))) %>% # exclude team-based awards
  arrange(Winner) %>% 
  mutate(league_season = paste0(League, " S", Season)) %>% 
  select(Winner, Award, Details, league_season)

rm(all_awards, awards_tidy)

# Show final table
reactable(awards,
          pagination = TRUE, 
          fullWidth = TRUE,
          resizable = TRUE,
          searchable = TRUE,
          columns = list(
            Winner = colDef(name = "Player", align = "left", minWidth = 200),
            Award = colDef(name = "Award", minWidth = 150),
            Details = colDef(name = "Details", minWidth = 250),
            league_season = colDef(name = "League / Season", minWidth = 150)
            )
)
```



### About this page

:::about
- This page was last compiled on `r format(Sys.time(), '%d %B %Y')`.
- Its contents are presented purely for general interest. They are not guaranteed to be comprehensive, complete, accurate, or up to date. They may be periodically revised to incorporate updates and bugfixes.
- All statistics based on Lichess game data do not account for games that lasted less than 5 plies (half-moves), games that ended in a disconnection or by "cheat detected", games that were aborted, and games that started from a custom position.,
- Former league players that were determined by Lichess to have violated their Terms of Service when this report was compiled should not appear in any detailed statistics. However, some may still appear in lists of season winners and top finishers.
- [Homepage](https://rahulan-c.github.io/lichess4545-stats/) / [source code](https://github.com/rahulan-c/lichess4545-stats)
:::

