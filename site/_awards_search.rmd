---
title: "All-time accolades"
description: |
  Player achievements in Lichess4545, LoneWolf and Lichess960
date: "`r Sys.Date()`"
site: distill::distill_website
output: distill::distill_article
---

```{r packages_initial_opts, include = FALSE}
# Set default R chunk options for Rmd file
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

# Load all required packages, incl. for functions
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, knitr, rio, data.table,
               reactable, htmltools, httr, jsonlite, xml2, 
               rvest, lubridate, tictoc, gt, glue, here)

# Define custom default reactable theme for tables
options(reactable.theme = reactableTheme(
    borderColor = "#dfe2e5",
    stripedColor = "#f6f8fa",
    highlightColor = "#f0f5f9",
    cellPadding = "8px 12px",
    searchInputStyle = list(width = "100%"),
    headerStyle = list(
      "&:hover[aria-sort]" = list(background = "hsl(0, 0%, 96%)"),
      "&[aria-sort='ascending'], &[aria-sort='descending']" = list(background = "hsl(0, 0%, 96%)"),
      borderColor = "#555"
    ),
    style = list(fontSize = "16px")
  )
)


Get4545PodiumPlayersFromReports <- function(pos, min_games = 2){
      if(pos == 1){data <- podium_rosters$Gold %>% unlist()}
      if(pos == 2){data <- podium_rosters$Silver %>% unlist()}
      if(pos == 3){data <- podium_rosters$Bronze %>% unlist()}
      data <- data[data != ""]
      data <- tibble::tibble(
        player = str_extract(data, "[:graph:]+(?=\\s)"),
        games = as.numeric(str_extract(data, "(?<=\\()\\d(?=\\))"))
      ) %>% 
        filter(games >= min_games)
      return(data)
}


GetPodiumPlayersFromReports <- function(url, tag){
      place <- read_html(url) %>% 
        rvest::html_element(tag) %>%
        rvest::html_text2() %>% 
        str_split("\n\n")
      place[[1]][2] <- str_remove_all(place[[1]][2], "\n")
      return(c(place[[1]][1], place[[1]][2], place[[1]][3]))
    }

```

This page shows everyone who's achieved some form of recognition in a published season stats report. It was last updated on **`r paste0(lubridate::day(lubridate::today()), " ", lubridate::month(lubridate::today(), label = T), " ", lubridate::year(lubridate::today()))`**.

[Return to home page](https://rahulan-c.github.io/lichess4545-stats/)

```{r setup}
# Min games to qualify as title winner
min_games <- 4

# Exclude ToS violators from page
scrub_cheats <- TRUE

# Get list of ToS violators
if(scrub_cheats){
  # Get list of ToS violators
  # Requires SourceScripts() to have been run first (in scratchpad.R)
  source(glue("{here()}/R/identify_tos_violators.R"))
}
```



### Players with multiple titles

*Currently only available for 4545; LW, 960 (and maybe other leagues) will be added soon.*

```{r extract_4545_podium_details, eval = TRUE}

# Extract all links from season reports table on homepage
season_reports_url <- "https://rahulan-c.github.io/lichess4545-stats/season_stats.html"
season_reports <- read_html(season_reports_url) %>% 
  html_nodes("table") %>% 
  html_nodes("tr") %>% 
  html_nodes("a") %>%
  html_attr("href")

# Identify 4545 reports
team4545_reports <- season_reports[stringr::str_detect(season_reports, "stats_4545")]

# List for storing
all_podiums <- list()
for(s in seq(1:length(team4545_reports))){
  
  url <- team4545_reports[s]
  season <- as.integer(str_extract(url, "(?<=_s)\\d+"))
  
  # Extract podium team names
  
  first <- read_html(url) %>%
    rvest::html_element(".first") %>% 
    html_text2() %>% 
    stringr::str_remove("^.+place") %>% 
    stringr::str_remove_all("\\n")
  
  second <- read_html(url) %>%
    rvest::html_element(".second") %>% 
    html_text2() %>% 
    stringr::str_remove("^.+place") %>% 
    stringr::str_remove_all("\\n")
  
  third <- read_html(url) %>%
    rvest::html_element(".third") %>% 
    html_text2() %>% 
    stringr::str_remove("^.+place") %>% 
    stringr::str_remove_all("\\n")
  
  # Extract final standings table info
  # S30 and later, extract xml_child 9
  # S12: xml_child 8
  # Other: xml_child 6
  if(season >= 30){
    podium_players <- read_html(url) %>%
      rvest::html_element("#final-standings") %>% 
      xml_child(9) %>% 
      html_text2() %>% 
      parse_json()
  } else if (season == 12){
    podium_players <- read_html(url) %>%
      rvest::html_element("#final-standings") %>% 
      xml_child(8) %>% 
      html_text2() %>% 
      parse_json()
  } else {
    podium_players <- read_html(url) %>%
      rvest::html_element("#final-standings") %>% 
      xml_child(6) %>% 
      html_text2() %>% 
      parse_json()
  }

  podium_players <- as_tibble(podium_players$x$tag$attribs$data)
  
  gold_subset <- tibble::enframe(podium_players$Gold) %>% 
    mutate(season = season,
           place = 1,
           team = first,
           value = unlist(value),
           games = stringr::str_extract(value, "\\([:digit:]\\)")
    ) %>% 
    mutate(games = stringr::str_remove(games, "\\(")) %>% 
    mutate(games = stringr::str_remove(games, "\\)")) %>% 
    mutate(games = as.integer(games)) %>% 
    mutate(value = stringr::str_remove(value, "\\s\\(.+\\)")) %>% 
    rename("player" = value) %>% 
    select(player, season, place, team, games) %>% 
    filter(games >= min_games)
  
  silver_subset <- tibble::enframe(podium_players$Silver) %>% 
    mutate(season = season,
           place = 2,
           team = second,
           value = unlist(value),
           games = stringr::str_extract(value, "\\([:digit:]\\)")
    ) %>% 
    mutate(games = stringr::str_remove(games, "\\(")) %>% 
    mutate(games = stringr::str_remove(games, "\\)")) %>% 
    mutate(games = as.integer(games)) %>% 
    mutate(value = stringr::str_remove(value, "\\s\\(.+\\)")) %>% 
    rename("player" = value) %>% 
    select(player, season, place, team, games) %>% 
    filter(games >= min_games)
  
  bronze_subset <- tibble::enframe(podium_players$Bronze) %>% 
    mutate(season = season,
           place = 3,
           team = third,
           value = unlist(value),
           games = stringr::str_extract(value, "\\([:digit:]\\)")
    ) %>% 
    mutate(games = stringr::str_remove(games, "\\(")) %>% 
    mutate(games = stringr::str_remove(games, "\\)")) %>% 
    mutate(games = as.integer(games)) %>% 
    mutate(value = stringr::str_remove(value, "\\s\\(.+\\)")) %>% 
    rename("player" = value) %>% 
    select(player, season, place, team, games) %>% 
    filter(games >= min_games)
  
  all_podiums[[s]] <- rbind(gold_subset, silver_subset, bronze_subset)
  
  cli::cli_alert_success("Extracted podium team/player data for 4545 S{season}")
  
  Sys.sleep(0.2)
  
}

alltime_podiums <- data.table::rbindlist(all_podiums) %>% tibble::as_tibble()

# Remove any Lichess TOS violators from the final results
if(scrub_cheats){
  alltime_podiums <- alltime_podiums %>% 
    filter(!(str_to_lower(player) %in% str_to_lower(tos_violators)))
}

```

```{r multiple_4545_winners, eval = TRUE}

# Multiple season winners
multiple_titles <- alltime_podiums %>% 
  filter(place == 1) %>% 
  group_by(player) %>% 
  summarise(titles = n()) %>% 
  # filter(titles > 1) %>% 
  arrange(desc(titles))

# Show table of multiple title winners
# Format: titles, players
titles_range <- sort(unique(multiple_titles$titles),
                     decreasing = T)
titles_table <- tibble::tibble(
  titles = titles_range,
  players = rep(NA_character_, length(titles_range))
)
for(t in titles_range){
  players <- multiple_titles %>% 
    filter(titles == t) %>% 
    select(player) %>% 
    dplyr::pull()
  if(t == 1){
    # players <- paste0("(", length(players), " players")
    players <- glue::glue("({length(players)} players - too many to list)")
  } else {
    # players <- paste0(length(players), " player(s): ",
    #                   str_c(players, collapse = ", "))
    players <- glue::glue("{str_c(players, collapse = ', ')}")
  }
  titles_table$players[which(titles_range == t)] <- players
}

gt(titles_table) %>%
  tab_header(title = "Players with multiple 4545 titles",
             subtitle = "Seasons 2-35") %>%
  cols_label(
    titles = "Titles",
    players = "Players",
  ) %>% 
  tab_source_note(
    source_note = glue("A title winner is defined here as someone who played at least {min_games} games for a title-winning team."))

```

### Most successful players

*Like before, this only includes 4545 finishes at the moment. LW, 960 and other leagues will be incorporated soon.*

```{r most_successful_players, eval = TRUE}

# Highest-finishing players overall
success <- alltime_podiums %>% 
  group_by(player) %>% 
  summarise(first = sum(place == 1),
            second = sum(place == 2),
            third = sum(place == 3)) %>% 
  mutate(success_score = (first * 3) + (second * 2) + (third)) %>% 
  arrange(desc(success_score), desc(first), desc(second), desc(third))

# Show table of first 20 (ish)
success %>% 
  slice_max(success_score, n = 20) %>% 
  gt() %>% 
  tab_header(title = "Most successful 4545 players",
             subtitle = "Seasons 2-35") %>% 
  cols_label(
    player = "Player",
    first = "1st",
    second = "2nd",
    third = "3rd",
    success_score = "Success 'Score'"
  ) %>% 
  tab_footnote(
    footnote = "Success score = (3 * 1st-place finishes) + (2 * 2nd-place finishes) + 3rd-place finishes",
    locations = cells_column_labels(columns = success_score)
  ) %>% 
  tab_source_note(
    source_note = glue("To be eligible for inclusion, players must have played at least {min_games} games for a podium-finishing team."))
  
```


### All accolades

This is a searchable table that shows every eligible player who has been recognised in a published season report ([example](https://rahulan-c.github.io/lichess4545-stats/reports/stats_lwopen_s05.html#Awards)). Details are only included for award winners. See below the table for a list of award definitions. 



```{r, eval = FALSE, layout="l-page"}
# Crawl over the other reports and present all winners in one table

cli::cli_h2("Updating all-time awards search page...")

# Extract all links from season reports table on homepage
cli::cli_inform("Identifying published reports...")
homepage_url <- "https://rahulan-c.github.io/lichess4545-stats/season_stats.html"

season_reports <- xml2::read_html(homepage_url) %>% 
  html_nodes("table") %>% 
  html_nodes("tr") %>% 
  html_nodes("a") %>%
  html_attr("href") %>% 
  sort()

cli::cli_inform("{length(season_reports)} published reports need to be processed...")

# # Save list of season reports locally
# season_reports_tidied <- tibble::tibble(id = seq(1:length(season_reports)),
#                                   link = season_reports)
# readr::write_csv(season_reports_tidied,
#                  file = glue::glue(here::here(), "/data/published_reports.csv"))
# 
# # Find newly published reports 
# prev_published <- readr::read_csv(glue::glue(here::here(), "/data/published_reports.csv")) %>% 
#   dplyr::select(link) %>% 
#   dplyr::pull()
# 
# newly_published <- setdiff(season_reports, prev_published)
# # newly_published <- season_reports

cli::cli_inform("Extracting awards info from published reports...")

# If new season reports have been published...
# Need to loop through the new reports and extract award winners/details
all_awards <- list(rep(NA, length(season_reports)))

for(s in seq(1:length(season_reports))){ 
  url <- season_reports[s] # ditto
  league <- ifelse(str_detect(url, "stats_4545"), 
                   "4545", 
                   ifelse(str_detect(url, "stats_lwopen"), 
                          "LW Open", 
                          ifelse(str_detect(url, "stats_lwu1800"), 
                                 "LW U1800", 
                                 ifelse(str_detect(url, "stats_chess960"),
                                        "Chess960",
                                        ""))))
  
  season <- as.integer(str_extract(url, "(?<=_s)\\d+"))
  
  cli::cli_inform("Extracting info for {league} S{season}...")
  
  # Get the right XML child number for the league/season
  # Required because the Dec 2021 changes to season reports changed the section
  # order...so all reports produced since then should use 4, and all reports
  # yet to be re-produced should use 5.
  xml_child_number <- ifelse(league == "4545",
                             4,
                             
                             ifelse(league == "LW Open",
                                    ifelse(season %in% c(10, 13, 21:29), # seasons with latest format reports
                                           4, 5),
                                    
                                    ifelse(league == "LW U1800",
                                            ifelse(season %in% c(11, 13, 22:29), # seasons with latest format reports
                                                   4, 5),
                                           
                                           ifelse(league == "Chess960",
                                                  4,
                                                  NA_real_))))
  
  
  # Read and parse each report's awards table
  awards <- read_html(url) %>%
    rvest::html_element("#awards") %>% 
    xml_child(xml_child_number) %>% 
    html_text2() %>% 
    parse_json()
  
  # Tidy award data
  awards_tidy <- as_tibble(awards$x$tag$attribs$data) %>%
    mutate(League = league, Season = season) %>% 
    select(-c(Image)) %>% 
    select(League, Season, Award, Winner, Details, Mentions) %>% 
    # Flatten list to columns, turning NULL values to NAs
    mutate(Award = Award %>% lapply(function(x) ifelse(is.null(x), NA, x)) %>% purrr::flatten() %>% unlist(),
           Winner = Winner %>% lapply(function(x) ifelse(is.null(x), NA, x)) %>% purrr::flatten() %>% unlist(),
           Details = Details %>% lapply(function(x) ifelse(is.null(x), NA, x)) %>% purrr::flatten() %>% unlist(),
           Mentions = Mentions %>% lapply(function(x) ifelse(is.null(x), NA, x)) %>% purrr::flatten() %>% unlist()
           )
  
  # Now add non-awards data

  # Get 4545 podium players
  
  if(league == "4545"){
    # As at 28 Nov 2022, only seasons 12, 30, 31, 32 have point info included
    # in the podium box info, so their XML child number for extracting podium team
    # player info is 9, whereas for all other 4545 seasons it's 6.
    
    # Identify last published 4545 season
    latest_published_season <- str_extract(team4545_reports[1], "[:digit:]{2}(?=\\.html)") %>% 
      as.integer()
    
    # Reports where podium info includes player points
    # Relevant for scraping
    with_podiumpoints <- c(12, 30:latest_published_season)
    
    if(!(season %in% with_podiumpoints)){
      x <- 6
    } else {
        if(season == 12){
          x <- 8
        } 
      else {
        x <- 9
      }}
    
    podium_rosters <- read_html(url) %>%
    rvest::html_element("#final-standings") %>% 
    xml_child(x) %>% 
    html_text2() %>% 
    parse_json
    
    podium_rosters <- as_tibble(podium_rosters$x$tag$attribs$data)
    
    first <- Get4545PodiumPlayersFromReports(1) %>% mutate(pos = "first")
    second <- Get4545PodiumPlayersFromReports(2) %>% mutate(pos = "second")
    third <- Get4545PodiumPlayersFromReports(3) %>% mutate(pos = "third")
    podium_players <- rbind(first, second, third)
    
    # Use same format as awards data
    podium_players <- podium_players %>% 
      rename("Winner" = player) %>% 
      mutate(Award = case_when(
               pos == "first" ~ "1ST PLACE - SEASON WINNER",
               pos == "second" ~ "2ND PLACE",
               pos == "third" ~ "3RD PLACE",
               TRUE ~ NA_character_
             ),
             Details = paste0("Played ", games, " games"),
             Mentions = "", 
             League = league,
             Season = season) %>% 
      select(League, Season, Award, Winner, Details, Mentions)
    
    # Add podium player info to awards data
    awards_tidy <- rbind(awards_tidy, podium_players)
    
    # Identify board medallists and their stats
    board_medals <- read_html(url) %>%
      rvest::html_element("#board-medals") %>% 
      xml_child(4) %>% 
      html_text2() %>% 
      parse_json()
    board_medals <- as_tibble(board_medals$x$tag$attribs$data)
    board_medals <- board_medals %>% 
      mutate(board = as.integer(board),
             games = as.integer(games),
             points = as.numeric(points),
             bperf_rating = round(as.numeric(bperf_rating)),
             medal = rep(c("Board Medal - Gold", "Board Medal - Silver", "Board Medal - Bronze"), nrow(.)/3)) %>% 
      rename("Award" = medal, "Winner" = player) %>% 
      mutate(Details = paste0(points, "/", games, " on Board ", board, " (", bperf_rating, " perf)"),
             Mentions = "",
             League = league,
             Season = season) %>% 
      select(League, Season, Award, Winner, Details, Mentions)
    
    # Add board medals info to awards data
    awards_tidy <- rbind(awards_tidy, board_medals)
    
  }

  # For LW/960, get podium players and prize winners
  if(league %in% c("LW Open", "LW U1800", "Chess960")){
    
    first <- GetPodiumPlayersFromReports(url, ".first")
    second <- GetPodiumPlayersFromReports(url, ".second")
    third <- GetPodiumPlayersFromReports(url, ".third")
    prize <- GetPodiumPlayersFromReports(url, ".prize")
    
    podium_data <- tibble::tibble(
      pos = c(first[1], second[1], third[1], prize[1]),
      Winner = c(first[2], second[2], third[2], prize[2]),
      Details= c(first[3], second[3], third[3], prize[3])
    )
    
    podium_data <- podium_data %>% 
      mutate(Award = case_when(
        pos == "1st place" ~ "1ST PLACE - SEASON WINNER",
        pos == "2nd place" ~ "2ND PLACE",
        pos == "3rd place" ~ "3RD PLACE",
        pos == "Best U1600" ~ "BEST U1600",
        pos == "Best U2000" ~ "BEST U2000",
        TRUE ~ NA_character_
      ),
      Mentions = "",
      League = league,
      Season = season) %>% 
      select(League, Season, Award, Winner, Details, Mentions)
    
    # Add board medals info to awards data
    awards_tidy <- rbind(awards_tidy, podium_data)
      
    
  }
  
  
  all_awards[[s]] <- awards_tidy
  cli::cli_alert_success("Obtained awards data for {league} S{season}")
  Sys.sleep(0.1)
}

# After going through the newly published reports
# Combine everything into a single data frame
awards <- data.table::rbindlist(all_awards) %>% 
  tibble::as_tibble()

# Tidy the combined awards data
awards <- awards %>% 
  filter(Winner != "") %>% # exclude non-awarded awards
  filter(!(Award %in% c("Egalitarian Award", "Team Accuracy", "Radjabov Award"))) %>% # exclude team-based awards
  arrange(Winner) %>% 
  mutate(league_season = paste0(League, " S", Season)) %>% 
  select(Winner, league_season, Award, Details, Mentions)


  
  
  
    
  awards$Winner <- str_replace_all(awards$Winner, "^,\\s", "")
  rm(all_awards, awards_tidy)

  # # Save new awards data
  # readr::write_csv(awards,
  #                  file = glue::glue(here::here(), "/data/new_award_winners.csv")
  # )
  
  # # Read previous published all-seasons awards table
  # prev_awards <- readr::read_csv(glue::glue(here::here(), "/data/all_award_winners.csv"))

  # # Add newly published awards to previous all-seasons table
  # latest_awards <- rbind(prev_awards, awards)
  # latest_awards <- latest_awards %>% arrange(Winner)
  
  # # Save combined awards data
  # readr::write_csv(latest_awards,
  #                file = glue::glue(here::here(), "/data/all_award_winners.csv"))
  
  # latest_awards <- awards %>% arrange(Winner)
  


# # Read previous published all-seasons awards table
# latest_awards <- readr::read_csv(glue::glue(here::here(), "/data/all_award_winners.csv"))
# latest_awards <- latest_awards %>% tibble::as_tibble()

awards <- awards %>% 
  arrange(Winner) %>% 
  tibble::as_tibble()

# Scrub ToS violators
tos_violators <- identify_tos_violators() # requires SourceScripts() to have been run

toscrub <- str_c(tos_violators, collapse = "|") 
awards$Winner <- stringr::str_remove_all(awards$Winner, 
                                                  toscrub)
# Tidy up any after-effects
awards$Winner <- str_replace_all(awards$Winner, "^,\\s", "")
awards$Winner <- str_replace_all(awards$Winner, ",\\s,", ",")
awards$Winner <- str_replace_all(awards$Winner, ",\\s,", ",")

# # Save and publish new all-seasons table
# readr::write_csv(latest_awards,
#                  file = glue::glue(here::here(), "/data/all_award_winners.csv"))

# Publish latest awards table

# First read it again
# latest_awards <- readr::read_csv(glue::glue(here::here(), "/data/all_award_winners.csv"))
# latest_awards <- latest_awards %>% tibble::as_tibble()

# Tidy final table
awards_tidied <- awards %>% 
  tidyr::separate(col = league_season,
                  into = c("league", "season"),
                  sep = "S(?=\\d+)") %>% 
  mutate(league = str_trim(league), 
         season = str_trim(season)) %>% 
  tidyr::separate_rows(Winner, sep = ",\\s") %>% 
  mutate(Winner = str_trim(Winner)) %>% 
  tidyr::separate_rows(Mentions, sep = ",\\s") %>% 
  mutate(Mentions = str_trim(Mentions))

winners_tidied <- awards_tidied %>% 
  filter(!(is.na(Winner))) %>% 
  dplyr::select(-c(Mentions)) %>% 
  mutate(winner = TRUE,
         runnerup = FALSE) %>% 
  rename("Player" = Winner) %>% 
  dplyr::select(Player, Award, league, season, winner, runnerup, Details)

mentions_tidied <- awards_tidied %>% 
  filter(!(is.na(Mentions))) %>% 
  dplyr::select(-c(Winner)) %>% 
  mutate(winner = FALSE,
         runnerup = TRUE,
         Details = "") %>% 
  rename("Player" = Mentions) %>% 
  dplyr::select(Player, Award, league, season, winner, runnerup, Details)

awards_final <- rbind(winners_tidied, mentions_tidied)

awards_final <- awards_final %>% 
  dplyr::distinct(., .keep_all = T) %>% 
  mutate(position = case_when(
    winner == TRUE ~ "Winner",
    runnerup == TRUE ~ "2nd/3rd",
    TRUE ~ NA_character_
  )) %>% 
  mutate(season = as.numeric(season)) %>% 
  dplyr::select(Player, Award, league, season, position, Details)

# Do a final scrub of all ineligible players
awards_final$Player <- stringr::str_remove_all(
  stringr::str_to_lower(awards_final$Player), 
  stringr::str_to_lower(toscrub))

# Remove rows with empty 'player' values
awards_final <- awards_final %>% 
  filter(!(is.na(Player))) %>% 
  filter(Player != "")

# Show final table
reactable(awards_final,
          filterable = TRUE,
          pagination = TRUE, 
          fullWidth = TRUE,
          resizable = TRUE,
          searchable = TRUE,
          compact = TRUE,
          striped = TRUE,
         
          columns = list(
            Player = colDef(name = "Player", align = "left", minWidth = 200),
            Award = colDef(name = "Award", minWidth = 150),
            league = colDef(name = "League", minWidth = 100),
            season = colDef(name = "Season", minWidth = 90),
            position = colDef(name = "Rank", minWidth = 100),
            Details = colDef(name = "Details", minWidth = 250)
            ),
           defaultSorted = c("Award", "Player", "position")
)

cli::cli_alert_success("The all-seasons awards page has been updated")

```



- **Aces**: scored +6 or better
- **Archbishop of Accuracy**: lowest average centipawn loss (ACPL) in undecided positions after move 10
- **Awesome Alt**: played for the most teams during the season
- **Bullet Boss**: most moves made in under 0.5 seconds
- **David Award**: faced the strongest opposition
- **Gambit Guru**: best score playing gambits
- **Giri Award**: most draws
- **Grischuk's Cousin**: least time remaining after move 10 while going on to win
- **Houdini Award**: biggest comebacks
- **Intimate with Increment**: highest % of moves played with less than a minute on the clock
- **Marathon Mover**: most moves played across all games
- **Musing or Snoozing**: longest time spent on a single move
- **MVP Award**: best season performance rating relative to initial rating
- **Need for Speed**: most wins/draws while gaining time on the clock 
- **Primates of Precision**: most games < 10 ACPL
- **Rookie Award**: best season performance rating for a new league player
- **Saved by the Bell**: most moves made with < 5s left before winning
- **Slingshot Specialist**: most upset wins across the season
- **Tarjan Award**: achieved the biggest upset
- **Tetrarch of Time**: spent the most clock time across the season




