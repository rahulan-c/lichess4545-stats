---
title: "League info"
description: |
  Check which leagues are currently active     
output: distill::distill_article
site: distill::distill_website
---



```{r prelim, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, data.table, assertthat, xml2, rvest, lubridate, knitr)
```



### League status checker

```{r check_status}

today <- lubridate::today()
root <- "https://www.lichess4545.com/"
web_leagues <- c("team4545", "lonewolf", "chess960")
season_durations <- c(8, 11, 7)
all_leagues <- list()

# Check status of each website league
for (l in seq(1:length(web_leagues))){
  
  league <- web_leagues[[l]]
  duration <- season_durations[[l]]
  homepage <- read_html(paste0(root, league, "/"))
  
  # Identify current season
  if(league %in% c("team4545", "chess960")){
    season <- homepage %>% 
      rvest::html_element(".col-xs-12+ .col-xs-12 .well:nth-child(1) h3") %>% 
      html_text2() %>% 
      str_extract("Season.+$") %>% 
      str_extract("\\d+") %>% 
      as.integer()
  } else {
    # LW
    season <- homepage %>% 
      rvest::html_element(".col-xs-12+ .col-xs-12 .well:nth-child(1) h3") %>% 
      html_text2() %>% 
      str_extract("#.+\\s") %>% 
      str_extract("\\d+") %>% 
      as.integer()
  }
  
  assert_that(is.number(season))
  
  # Identify current round
  Sys.sleep(0.2)
  if(league %in% c("team4545", "chess960")){
    round <- read_html(paste0(root, league, "/season/", season, "/pairings/")) %>% 
      rvest::html_element(".round-switcher:nth-child(1) .dropdown-toggle") %>% 
      html_text2() %>% 
      str_extract("\\d+") %>% 
      as.integer()
  } else {
    # LW
    round <- read_html(paste0(root, league, "/season/", season, "/pairings/")) %>% 
      rvest::html_element(".inline+ .round-switcher .dropdown-toggle") %>% 
      html_text2() %>% 
      str_extract("\\d+") %>% 
      as.integer()
  }
  
  assert_that(is.number(round))
  
  # Check whether the current season is still active
  #   Looks for a winners table on the season summary page with the header
  #   "Season X Winners". If this isn't found, then the season hasn't been closed.
  if((league == "team4545") & (round == 8)) {
    Sys.sleep(0.2)
    active <- read_html(paste0(root, league, "/season/", season, "/summary/")) %>% 
      rvest::html_element(".col-md-8 h3") %>% 
      html_text2() %>% 
      is.na()
    
  } else if ((league == "lonewolf") & (round == 11)){
    Sys.sleep(0.2)
    active <- read_html(paste0(root, league, "/season/", season, "/summary/")) %>% 
      rvest::html_element(".col-md-8 h3") %>% 
      html_text2() %>% 
      is.na()
  
  } else if ((league == "chess960") & (round == 7)){
    Sys.sleep(0.2)
    active <- read_html(paste0(root, league, "/season/", season, "/summary/")) %>% 
      rvest::html_element(".col-md-8 h3") %>% 
      html_text2() %>% 
      is.na()
  
  } else {
    active <- TRUE
  }
  
  # Identify season end date
  # Requires "Season X ends on Month DD, YYYY" to appear on the league homepage
  # Doesn't show when registrations are closed
  
  # First check for phrase "Registration is open!"
  regs_open <- homepage %>% html_text2() %>% str_detect("Registration is open!")
  
  # If registrations are open...
  if(regs_open){
    if(league == "team4545"){
      season_end <- homepage %>% 
        rvest::html_element(".well+ .well p") %>% 
        html_text2() %>% 
        str_extract("(January|February|March|April|May|June|July|August|September|October|November|December)\\s\\d+,\\s\\d{4}") %>% 
        str_remove_all(",") %>% 
        lubridate::mdy()
      
    } else if (league == "chess960"){
      season_end <- homepage %>% 
        rvest::html_element(".well+ .well p") %>% 
        html_text2() %>% 
        str_extract("(Jan.|Feb.|Mar.|Apr.|May|Jun.|Jul.|Aug.|Sep.|Oct.|Nov.|Dec.)\\s\\d+,\\s\\d{4}") %>% 
        str_remove_all(",") %>% 
        lubridate::mdy()
    }
  } else {
    
    # If registrations are closed...
    # Try identifying season dates from scheduled dates on pairings page
    pairings_url <- paste0(root, league, "/season/", season, "/pairings/")
    pairings_url <- "https://www.lichess4545.com/lonewolf/season/24/pairings/" # testing
    scheduled_times <- read_html(pairings_url) %>% 
      rvest::html_elements("time") %>% 
      rvest::html_text2()
    scheduled_times <- scheduled_times[!is.na(scheduled_times)]
    pairing_date <- sample(scheduled_times, 1) %>% 
      str_sub(1, 5) %>% 
      str_c(., "/", lubridate::year(lubridate::today())) %>% 
      lubridate::mdy()
    
    # Find the date when the current round started
    round_start <- pairing_date - lubridate::wday(pairing_date - 2)
    
    # Then compute season end date
    season_end <- round_start + lubridate::weeks(duration - round + 1)
  }
  
  # Identify season start date
  season_start <- season_end - lubridate::weeks(duration)
  
  # Convert to single character showing season duration
  season_dates <- paste0(lubridate::day(season_start), " ",
                       lubridate::month(season_start, label = T, abbr = T), 
                       " to ",
                       lubridate::day(season_end), " ",
                       lubridate::month(season_end, label = T, abbr = T), " ",
                       lubridate::year(season_end))
                       
  
  # Identify whether the league is in pre-season, mid-season or post-season
  pre_season <- lubridate::today() < season_start
  post_season <- season_end < lubridate::today()
  mid_season <- (season_start < lubridate::today()) & (lubridate::today() < season_end)
  status <- ifelse(mid_season, "mid", ifelse(pre_season, "pre", ifelse(post_season, "post")))
  
  # Summarise league status data
  all_leagues[[l]] <- c(league, season, round, season_start, season_end, season_dates, active, status, regs_open)
  # cli::cli_alert_success("{league}: identified status")
}

# Collate all leagues' status data into a tibble
statuses <- all_leagues %>% as.list()
names(statuses) <- web_leagues
statuses <- statuses %>% dplyr::bind_rows()
statuses <- as.data.frame(t(statuses))
colnames(statuses) <- c("league", "season", "round", "start", "end", "dates", "active", "status", "regs_open")
statuses$league <- NULL
statuses$start <- NULL
statuses$end <- NULL

statuses <- statuses %>% dplyr::select(season, dates, status, active, "current_round" = round, regs_open)

# Show all league statuses
kable(statuses)


```

**Notes**

- The table shows the current status of the 4545 Team, LoneWolf and Chess960 leagues. In the future, I plan to extend this to cover some community leagues too (like Series, Rapid Battle and Infinite Quest). Check out the [Lichess4545 overview](https://bit.ly/35w1xqH) to learn about all the leagues and initiatives run by the community.
- *status* - 'pre' means pre-season, 'mid' means mid-season, and 'post' means postseason (which may indicate that all games have been played but the final standings haven't been confirmed yet).
- *active* - 'FALSE' means the current season is over but registrations for the next season aren't open yet.
- *regs_open* - shows whether the league is currently accepting registrations. Note that for the 4545 league, if a season has started, then new registrants can only sign up to play as an alternate (since the teams for the season have already been made). 

